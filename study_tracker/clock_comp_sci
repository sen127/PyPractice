#!/usr/bin/env python3
"""Simple hour-tracking clock geared toward an 10,000 hour goal."""
from __future__ import annotations
import argparse
import json
import sys
from datetime import datetime
from pathlib import Path
from typing import Any, Dict
GOAL_HOURS = 10_000
STATE_FILE = Path(__file__).with_suffix(".json")
def _now() -> datetime:
    return datetime.now()
def _load_state() -> Dict[str, Any]:
    if STATE_FILE.exists():
        with STATE_FILE.open("r", encoding="utf-8") as fh:
            try:
                data = json.load(fh)
            except json.JSONDecodeError:
                data = {}
    else:
        data = {}
    data.setdefault("total_seconds", 0.0)
    data.setdefault("session_start", None)
    data.setdefault("session_date", None)
    data.setdefault("daily_totals", {})
    return data
def _save_state(state: Dict[str, Any]) -> None:
    with STATE_FILE.open("w", encoding="utf-8") as fh:
        json.dump(state, fh, indent=2, sort_keys=True)
def _format_hours(seconds: float) -> str:
    return f"{seconds / 3600:.2f}h"
def start_session() -> int:
    state = _load_state()
    if state["session_start"] is not None:
        print("Study clock already running.")
        return 1
    now = _now()
    state["session_start"] = now.timestamp()
    state["session_date"] = now.date().isoformat()
    _save_state(state)
    print(f"Started study session at {now.strftime('%H:%M:%S')}.")
    return 0
def stop_session() -> int:
    state = _load_state()
    start_ts = state.get("session_start")
    if start_ts is None:
        print("Study clock is not running.")
        return 1
    now = _now()
    elapsed = max(0.0, now.timestamp() - float(start_ts))
    state["total_seconds"] += elapsed
    day = state.get("session_date") or now.date().isoformat()
    daily = state.setdefault("daily_totals", {})
    daily[day] = daily.get(day, 0.0) + elapsed
    state["session_start"] = None
    state["session_date"] = None
    _save_state(state)
    remaining_hours = max(0.0, GOAL_HOURS - state["total_seconds"] / 3600)
    print(
        f"Session logged: {_format_hours(elapsed)} today "
        f"({day} total: {_format_hours(daily[day])})."
    )
    print(
        f"Progress: {_format_hours(state['total_seconds'])} studied, "
        f"{remaining_hours:.2f}h remaining toward {GOAL_HOURS}h goal."
    )
    return 0
def show_status() -> int:
    state = _load_state()
    now = _now()
    today_key = now.date().isoformat()
    daily = state.get("daily_totals", {})
    today_seconds = daily.get(today_key, 0.0)
    if state.get("session_start"):
        in_progress = max(0.0, now.timestamp() - float(state["session_start"]))
        if state.get("session_date") == today_key:
            today_seconds += in_progress
        print(
            f"Session in progress for {_format_hours(in_progress)} "
            f"(started {datetime.fromtimestamp(state['session_start']).strftime('%H:%M:%S')})."
        )
    else:
        print("No active study session.")
    total_seconds = state["total_seconds"]
    if state.get("session_start"):
        total_seconds += max(0.0, now.timestamp() - float(state["session_start"]))
    remaining_hours = max(0.0, GOAL_HOURS - total_seconds / 3600)
    print(f"Today's study time: {_format_hours(today_seconds)}.")
    print(
        f"Overall: {_format_hours(total_seconds)} completed, "
        f"{remaining_hours:.2f}h remaining toward {GOAL_HOURS}h."
    )
    return 0
def reset_progress() -> int:
    STATE_FILE.unlink(missing_ok=True)
    print("Study progress reset.")
    return 0
def _prompt_yes_no(question: str) -> bool:
    try:
        reply = input(f"{question} [Y/N]: ").strip().lower()
    except EOFError:
        return False
    return reply in {"y", "yes"}
def interactive_prompt() -> int:
    show_status()
    state = _load_state()
    if state.get("session_start"):
        start_time = datetime.fromtimestamp(float(state["session_start"]))
        if _prompt_yes_no(
            f"Study clock has been running since {start_time.strftime('%H:%M:%S')}. Stop it now?"
        ):
            return stop_session()
        return 0
    if _prompt_yes_no("No session running. Start studying now?"):
        return start_session()
    return 0
def main(argv: list[str]) -> int:
    parser = argparse.ArgumentParser(
        description="Track study hours toward a fixed goal."
    )
    sub = parser.add_subparsers(dest="command")
    sub.add_parser("start", help="Start the study clock.")
    sub.add_parser("stop", help="Stop the study clock and log the session.")
    sub.add_parser("status", help="Show progress toward the goal.")
    sub.add_parser("reset", help="Delete saved progress.")
    args = parser.parse_args(argv)
    if args.command is None:
        return interactive_prompt()
    if args.command == "start":
        return start_session()
    if args.command == "stop":
        return stop_session()
    if args.command == "status":
        return show_status()
    if args.command == "reset":
        return reset_progress()
    return 1
if __name__ == "__main__":
    sys.exit(main(sys.argv[1:]))
